# ---------- Build stage ----------
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /build

# Keep deps cached when only code changes
COPY pom.xml .
# Cache Maven repo between builds (BuildKit)
RUN --mount=type=cache,target=/root/.m2 \
    mvn -q -DskipTests dependency:go-offline

# Now copy sources; this is the layer that changes most
COPY src ./src
RUN --mount=type=cache,target=/root/.m2 \
    mvn -q -DskipTests package && \
    # adjust if your jar name ever changes
    cp target/*-SNAPSHOT.jar /build/app.jar

# ---------- Run stage ----------
FROM eclipse-temurin:17-jre-jammy

# Install runtime deps once; rarely changes
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      ffmpeg python3 python3-pip ca-certificates && \
    pip3 install --no-cache-dir yt-dlp==2025.09.26 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=build /build/app.jar /app/app.jar
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

VOLUME ["/app/config"]
ENTRYPOINT ["/bin/sh","-lc","/app/entrypoint.sh"]
